name: 'Deploy to Cloud Run'
description: 'Build Docker image with layer caching and deploy to Cloud Run'

inputs:
  environment:
    description: 'Deployment environment (preview or production)'
    required: true
  image-tags:
    description: 'Docker image tags (multiline string)'
    required: true
  deploy-image:
    description: 'Docker image to deploy (primary image with SHA)'
    required: true
  service-name:
    description: 'Cloud Run service name'
    required: true
    default: 'web'
  region:
    description: 'Cloud Run region'
    required: true
    default: 'asia-northeast1'
  registry:
    description: 'Docker registry URL'
    required: true
    default: 'asia-northeast1-docker.pkg.dev'
  no-traffic:
    description: 'Set to true for preview deployments'
    required: false
    default: 'false'
  revision-tag:
    description: 'Cloud Run revision tag (for preview)'
    required: false
  revision-traffic:
    description: 'Traffic allocation (for production)'
    required: false
outputs:
  url:
    description: 'Deployed service URL'
    value: ${{ steps.deploy.outputs.url }}

runs:
  using: 'composite'
  steps:
    # Docker Buildx セットアップ
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

    # Google Cloud Docker 認証
    - name: Configure Docker for Google Cloud
      shell: bash
      run: gcloud auth configure-docker ${{ inputs.registry }}

    # Docker イメージのビルドとプッシュ（GitHub Actions Cacheでキャッシング）
    - name: Build and push Docker image
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        context: .
        push: true
        tags: ${{ inputs.image-tags }}
        # GitHub Actions Cache を使った Docker Layer Caching
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # crane セットアップ（イメージメトリクス取得用）
    - name: Setup crane
      uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4

    # イメージマニフェスト取得（デプロイパフォーマンス分析用）
    - name: Fetch image manifest
      shell: bash
      run: |
        mkdir -p /tmp/deploy-metrics

        # crane に Google Cloud 認証を設定
        gcloud auth print-access-token | crane auth login ${{ inputs.registry }} -u oauth2accesstoken --password-stdin

        # マニフェストを取得してJSONファイルとして保存
        crane manifest --platform linux/amd64 ${{ inputs.deploy-image }} > /tmp/deploy-metrics/manifest.json

        # メタデータを追加
        jq -n \
          --arg image "${{ inputs.deploy-image }}" \
          --arg env "${{ inputs.environment }}" \
          --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          '{image: $image, environment: $env, timestamp: $timestamp}' > /tmp/deploy-metrics/metadata.json

    # マニフェストをアーティファクトとして保存
    - name: Upload image manifest
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: deploy-metrics-${{ inputs.environment }}
        path: /tmp/deploy-metrics/
        retention-days: 30

    # Cloud Run デプロイ（事前ビルド済みイメージを使用）
    - name: Deploy to Cloud Run
      id: deploy
      uses: 'google-github-actions/deploy-cloudrun@2028e2d7d30a78c6910e0632e48dd561b064884d' # v3.0.1
      with:
        service: ${{ inputs.service-name }}
        region: ${{ inputs.region }}
        image: ${{ inputs.deploy-image }}
        no_traffic: ${{ inputs.no-traffic }}
        tag: ${{ inputs.revision-tag }}
        revision_traffic: ${{ inputs.revision-traffic }}
        flags: '--allow-unauthenticated'
