---
import { render, type CollectionEntry } from 'astro:content';
import { differenceInDays } from 'date-fns';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate';
import Header from '../components/Header.astro';
import MainContainer from '../components/MainContainer.astro';
import PostNavigation from '../components/PostNavigation.astro';
import ShareButtons from '../components/ShareButtons.astro';
import Tag from '../components/Tag.astro';
import TagList from '../components/TagList.astro';
import ArticleSummarizer from '../components/ArticleSummarizer';
import { SITE_TITLE } from '../consts';
import { queryAvailablePosts } from '@lib/query';
import { getRelativePostUrl } from '../libs/compat';

type Props = {
  entry: CollectionEntry<'posts'>;
  adjacentPosts: {
    prev: CollectionEntry<'posts'> | null;
    next: CollectionEntry<'posts'> | null;
  };
};

const { entry, adjacentPosts } = Astro.props;
const { slug, title, category, tags, created_time, last_edited_time, locale, canonical_url, published, features } =
  entry?.data;
const isUpdated = differenceInDays(last_edited_time, created_time) > 0;
const { Content } = await render(entry);

// 言語切り替え用に同じslugの別locale記事を検索
const allPosts = await queryAvailablePosts();
const alternateLocalePosts = allPosts.filter(
  (post) => post.data.slug === entry.data.slug && post.data.locale !== entry.data.locale
);
const alternatePost = alternateLocalePosts.length > 0 ? alternateLocalePosts[0] : null;
---

<!doctype html>
<html lang={locale || 'ja'}>
  <head>
    <BaseHead
      title={`${title} | ${SITE_TITLE}`}
      description={''}
      image={`/og/${slug}.png`}
      gtagProps={{
        post_slug: `${slug}`,
        post_locale: `${locale}`,
        post_title: `${title}`,
        post_timestamp: `${created_time.getTime()}`,
      }}
    />

    {canonical_url && <link rel="canonical" href={canonical_url} />}
    {features?.katex ? (
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous" />
    ) : null}
  </head>

  <body class="font-base bg-default">
    <Header showDescription class="" />

    <MainContainer>
      <article class="py-8 lg:py-16">
        <header class="mb-6">
          <div class="leading-none">
            <span class="text-sm text-muted">
              {
                published === false && (
                  <div class="flex bg-gray-600 text-white justify-center py-1 mt-2">
                    <span class="text-sm">DRAFT</span>
                  </div>
                )
              }
              <FormattedDate date={created_time} />
              {
                isUpdated && (
                  <span class="text-sm text-muted">
                    (Updated at: <FormattedDate date={last_edited_time} />)
                  </span>
                )
              }
            </span>
            <h1 class="text-2xl font-semibold leading-tight mb-1">{title}</h1>
            <div class="py-1 flex items-center justify-between">
              <TagList>
                {category && <Tag name={category} isCategory />}
                {tags && tags.map((tag) => <Tag name={tag} />)}
              </TagList>
              <div class="flex items-center gap-1">
                {
                  alternatePost && (
                    <a
                      href={getRelativePostUrl(alternatePost)}
                      class="flex items-center px-3 py-2 md:px-2 md:py-0 text-muted hover:text-default hover:bg-gray-100 transition-colors rounded-sm"
                      title={`Read in ${alternatePost.data.locale === 'en' ? 'English' : '日本語'}`}
                      aria-label={`Read in ${alternatePost.data.locale === 'en' ? 'English' : '日本語'}`}
                    >
                      <span class="icon-[mdi--translate] inline-block w-6 h-6" />
                    </a>
                  )
                }
                <a
                  href={`${getRelativePostUrl(entry)}.md`}
                  class="flex items-center px-3 py-2 md:px-2 md:py-0 text-muted hover:text-default hover:bg-gray-100 transition-colors rounded-sm"
                  title="View as Markdown"
                  aria-label="View as Markdown"
                >
                  <span class="icon-[simple-icons--markdown] inline-block w-6 h-6"></span>
                </a>
              </div>
            </div>
            {entry.body && <ArticleSummarizer locale={locale || 'ja'} content={entry.body} client:idle />}
          </div>
        </header>

        <div class="markdown-body mb-4">
          <Content />
        </div>

        <PostNavigation prev={adjacentPosts.prev} next={adjacentPosts.next} />

        <div class="mt-8">
          <ShareButtons url={Astro.url.toString()} title={`${title} | ${SITE_TITLE}`} />
        </div>
      </article>
    </MainContainer>

    <Footer class="py-4" />

    {features?.tweet ? <script is:inline async src="https://platform.twitter.com/widgets.js" charset="utf-8" /> : null}
    {features?.mermaid ? (
      <script>
        import mermaid from 'mermaid';
        mermaid.initialize({ startOnLoad: true });
      </script>
    ) : null}
  </body>
</html>
