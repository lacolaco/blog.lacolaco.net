[{"object":"block","id":"433ea073-f02e-4b72-9064-99ed87d0ea31","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:40:00.000Z","last_edited_time":"2023-11-12T14:41:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"Angular v17で簡単になったSSRを、Dockerでビルドしてデプロイできるようにする。やることは単純で、特に落とし穴になるようなことはない。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"Angular v17で簡単になったSSRを、Dockerでビルドしてデプロイできるようにする。やることは単純で、特に落とし穴になるようなことはない。","href":null}],"color":"default"}},{"object":"block","id":"e69337ed-a94d-4ce1-b725-b0be4300f02f","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:41:00.000Z","last_edited_time":"2023-11-12T14:42:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"まずは ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"まずは ","href":null},{"type":"text","text":{"content":"ng new","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"ng new","href":null},{"type":"text","text":{"content":" コマンドでアプリケーションを作成する。 ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" コマンドでアプリケーションを作成する。 ","href":null},{"type":"text","text":{"content":"--ssr","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"--ssr","href":null},{"type":"text","text":{"content":" フラグをつけなくても、プロンプトでSSRを有効にするかどうかは尋ねられるので、そこでYesと答えてもよい。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" フラグをつけなくても、プロンプトでSSRを有効にするかどうかは尋ねられるので、そこでYesと答えてもよい。","href":null}],"color":"default"}},{"object":"block","id":"460e4d83-ec1c-4e25-9857-456253d3ea0e","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:41:00.000Z","last_edited_time":"2023-11-12T14:45:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"code","code":{"caption":[],"rich_text":[{"type":"text","text":{"content":"$ ng new ng17-ssr-docker --ssr","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"$ ng new ng17-ssr-docker --ssr","href":null}],"language":"shell"}},{"object":"block","id":"ffc1a886-eaa4-4dd5-9c3a-85b7ed2d28bb","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:42:00.000Z","last_edited_time":"2023-11-12T14:44:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"正しくアプリケーションを作成できていれば、この時点で ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"正しくアプリケーションを作成できていれば、この時点で ","href":null},{"type":"text","text":{"content":"ng build","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"ng build","href":null},{"type":"text","text":{"content":" を実行すればSSR用のサーバーを立てるのに必要なファイルと設定はすべて済んでいる。ビルドを実行して出力された ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" を実行すればSSR用のサーバーを立てるのに必要なファイルと設定はすべて済んでいる。ビルドを実行して出力された ","href":null},{"type":"text","text":{"content":"dist/server","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"dist/server","href":null},{"type":"text","text":{"content":" ディレクトリが存在すれば問題ない。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" ディレクトリが存在すれば問題ない。","href":null}],"color":"default"}},{"object":"block","id":"40ca1632-9cb0-42b8-af76-49567101b2b8","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:44:00.000Z","last_edited_time":"2023-11-12T14:45:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"code","code":{"caption":[],"rich_text":[{"type":"text","text":{"content":"$ npm run build\n$ tree dist/\ndist/\n└── ng17-ssr-docker\n    ├── 3rdpartylicenses.txt\n    ├── browser\n    │   ├── favicon.ico\n    │   ├── index.html\n    │   ├── main-XALV5XXG.js\n    │   ├── polyfills-LZBJRJJE.js\n    │   └── styles-5INURTSO.css\n    ├── prerendered-routes.json\n    └── server\n        ├── chunk-53JWIC36.mjs\n        ├── chunk-KRLCULJA.mjs\n        ├── chunk-VP7Q5FIC.mjs\n        ├── chunk-YGUSPAT3.mjs\n        ├── index.server.html\n        ├── main.server.mjs\n        ├── polyfills.server.mjs\n        ├── render-utils.server.mjs\n        └── server.mjs","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"$ npm run build\n$ tree dist/\ndist/\n└── ng17-ssr-docker\n    ├── 3rdpartylicenses.txt\n    ├── browser\n    │   ├── favicon.ico\n    │   ├── index.html\n    │   ├── main-XALV5XXG.js\n    │   ├── polyfills-LZBJRJJE.js\n    │   └── styles-5INURTSO.css\n    ├── prerendered-routes.json\n    └── server\n        ├── chunk-53JWIC36.mjs\n        ├── chunk-KRLCULJA.mjs\n        ├── chunk-VP7Q5FIC.mjs\n        ├── chunk-YGUSPAT3.mjs\n        ├── index.server.html\n        ├── main.server.mjs\n        ├── polyfills.server.mjs\n        ├── render-utils.server.mjs\n        └── server.mjs","href":null}],"language":"shell"}},{"object":"block","id":"eed4d3b3-d749-4d4e-bbbc-0b741a99c487","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:44:00.000Z","last_edited_time":"2023-11-12T15:03:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"この中の ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"この中の ","href":null},{"type":"text","text":{"content":"server/server.mjs","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"server/server.mjs","href":null},{"type":"text","text":{"content":" をNode.jsで実行するとサーバーが起動する。試しに ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" をNode.jsで実行するとサーバーが起動する。試しに ","href":null},{"type":"text","text":{"content":"node","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"node","href":null},{"type":"text","text":{"content":" コマンドを実行して確認しよう。デフォルトではlocalhostの4000番ポートでサーバーが起動するので、ブラウザで開いてSSRされたHTMLが返却されていることがわかるはずだ。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" コマンドを実行して確認しよう。デフォルトではlocalhostの4000番ポートでサーバーが起動するので、ブラウザで開いてSSRされたHTMLが返却されていることがわかるはずだ。","href":null}],"color":"default"}},{"object":"block","id":"a015d71c-8e5a-47d9-81fb-5282f8546825","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:48:00.000Z","last_edited_time":"2023-11-12T15:03:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"code","code":{"caption":[],"rich_text":[{"type":"text","text":{"content":"$ node dist/ng17-ssr-docker/server/server.mjs\nNode Express server listening on http://localhost:4000","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"$ node dist/ng17-ssr-docker/server/server.mjs\nNode Express server listening on http://localhost:4000","href":null}],"language":"shell"}},{"object":"block","id":"b490e806-6b41-4447-bdc8-879e39b66a2c","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:48:00.000Z","last_edited_time":"2023-11-12T14:56:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"あとはこれを任意のNode.js環境にデプロイすればいい。Dockerを使う場合、最小構成は次のようになる。やることは、ビルド後の ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"あとはこれを任意のNode.js環境にデプロイすればいい。Dockerを使う場合、最小構成は次のようになる。やることは、ビルド後の ","href":null},{"type":"text","text":{"content":"dist","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"dist","href":null},{"type":"text","text":{"content":" ディレクトリの中身をコピーし、 ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" ディレクトリの中身をコピーし、 ","href":null},{"type":"text","text":{"content":"server/server.mjs","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"server/server.mjs","href":null},{"type":"text","text":{"content":" を実行するだけだ。サーバーサイドのスクリプトもAngular CLIによってバンドルされているため、実行環境で ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" を実行するだけだ。サーバーサイドのスクリプトもAngular CLIによってバンドルされているため、実行環境で ","href":null},{"type":"text","text":{"content":"npm install","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"npm install","href":null},{"type":"text","text":{"content":" をする必要はない。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" をする必要はない。","href":null}],"color":"default"}},{"object":"block","id":"df3f26b9-12dd-4ee7-a90e-e1fc17a08c41","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:47:00.000Z","last_edited_time":"2023-11-12T15:03:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"code","code":{"caption":[],"rich_text":[{"type":"text","text":{"content":"FROM node:20-buster-slim\nWORKDIR /app\nCOPY dist/ng17-ssr-docker/ /app\nCMD node server/server.mjs","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"FROM node:20-buster-slim\nWORKDIR /app\nCOPY dist/ng17-ssr-docker/ /app\nCMD node server/server.mjs","href":null}],"language":"docker"}},{"object":"block","id":"026fe7f4-a254-430c-8b31-672e8549de2e","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:49:00.000Z","last_edited_time":"2023-11-12T14:53:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"ビルドもDockerに任せたい場合はマルチステージビルドを使ってもよいが、個人的にはおすすめしない。昨今いろいろなCLIツールは永続キャッシュによる高速化が図られていることが多く、Dockerでビルドさせるとその恩恵が得にくいケースが多い。工夫すればできないことはないだろうが、物事をシンプルに保つうえであらかじめ ","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"ビルドもDockerに任せたい場合はマルチステージビルドを使ってもよいが、個人的にはおすすめしない。昨今いろいろなCLIツールは永続キャッシュによる高速化が図られていることが多く、Dockerでビルドさせるとその恩恵が得にくいケースが多い。工夫すればできないことはないだろうが、物事をシンプルに保つうえであらかじめ ","href":null},{"type":"text","text":{"content":"ng build","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":true,"color":"default"},"plain_text":"ng build","href":null},{"type":"text","text":{"content":" しておいた結果をコピーするだけに留めておくほうがよかろうと思う。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":" しておいた結果をコピーするだけに留めておくほうがよかろうと思う。","href":null}],"color":"default"}},{"object":"block","id":"d75a2f5c-d33b-4af7-9a86-3a85bd62fe54","parent":{"type":"page_id","page_id":"ee8cd85b-3e4f-48dd-b84d-b63d473cc5d7"},"created_time":"2023-11-12T14:53:00.000Z","last_edited_time":"2023-11-12T14:54:00.000Z","created_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"last_edited_by":{"object":"user","id":"f4f222d4-d508-405d-ba6c-da82ee26ee54"},"has_children":false,"archived":false,"type":"paragraph","paragraph":{"rich_text":[{"type":"text","text":{"content":"あとは適当にDockerイメージをビルドしてデプロイすれば終わりだ。いやあ簡単になったものだ。","link":null},"annotations":{"bold":false,"italic":false,"strikethrough":false,"underline":false,"code":false,"color":"default"},"plain_text":"あとは適当にDockerイメージをビルドしてデプロイすれば終わりだ。いやあ簡単になったものだ。","href":null}],"color":"default"}}]